<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management & Bookkeeping</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- FIX: Added jsPDF AutoTable Plugin CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8uR4/k1q3oTx+5K+Y/M6hY/FpB/KzC3d6e5Z9zB+k5p1S1U2H+2Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background for the overall app */
        }
        .view-container {
            min-height: calc(100vh - 80px); /* Account for header/nav height */
        }
        .tab-button.active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
        }
        /* Custom styles for sort indicators */
        .sortable {
            user-select: none;
        }
        /* Hidden arrow by default */
        .sortable .sort-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        /* Active arrow styles */
        .sortable:hover .sort-icon,
        .sort-active .sort-icon {
            opacity: 1;
        }
        .sort-active {
            color: #4f46e5; /* Highlight active sort column */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                        'card-bg': '#ffffff',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800">

    <!-- Global Message Box (for alerts) -->
    <div id="message-box" class="fixed top-4 right-4 z-50 transition-all duration-300 opacity-0 transform translate-y-[-20px]">
        <!-- Message content will be inserted here -->
    </div>

    <!-- Navigation Header -->
    <header class="bg-primary shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-white tracking-wider">BookKeep Pro</span>
                </div>
                <nav class="flex space-x-2 sm:space-x-4">
                    <button class="nav-button flex items-center space-x-2 p-2 rounded-lg text-white font-medium bg-primary hover:bg-indigo-600 transition duration-150" data-view="sales">
                        <i class="fa-solid fa-cash-register"></i>
                        <span class="hidden sm:inline">Register</span>
                    </button>
                    <button class="nav-button flex items-center space-x-2 p-2 rounded-lg text-white font-medium bg-primary hover:bg-indigo-600 transition duration-150" data-view="inventory">
                        <i class="fa-solid fa-boxes-stacked"></i>
                        <span class="hidden sm:inline">Inventory</span>
                    </button>
                    <button class="nav-button flex items-center space-x-2 p-2 rounded-lg text-white font-medium bg-primary hover:bg-indigo-600 transition duration-150" data-view="expenses">
                        <i class="fa-solid fa-file-invoice-dollar"></i>
                        <span class="hidden sm:inline">Expenses</span>
                    </button>
                    <button class="nav-button flex items-center space-x-2 p-2 rounded-lg text-white font-medium bg-primary hover:bg-indigo-600 transition duration-150" data-view="stats">
                        <i class="fa-solid fa-chart-line"></i>
                        <span class="hidden sm:inline">Reports</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 view-container">

        <!-- 1. Cash Register / Sales View -->
        <div id="sales-view" class="active-view grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Item List / Product Search (LHS) -->
            <div class="lg:col-span-2 bg-card-bg p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-primary">Products</h2>
                <input type="text" id="product-search" placeholder="Search products by name..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-primary">

                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Inventory items will be rendered here -->
                </div>
            </div>

            <!-- Transaction Panel / Cart (RHS) -->
            <div class="lg:col-span-1 bg-card-bg p-6 rounded-xl shadow-lg border-2 border-secondary">
                <h2 class="text-2xl font-bold mb-4 text-secondary">Current Transaction</h2>

                <div id="cart-items" class="h-64 overflow-y-auto mb-4 border-b pb-2">
                    <!-- Cart items will be rendered here -->
                </div>

                <div class="space-y-3 font-semibold text-lg border-t pt-4">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">0.00</span>
                    </div>
                    <div class="flex justify-between text-2xl font-extrabold text-primary">
                        <span>TOTAL:</span>
                        <span id="cart-total">0.00</span>
                    </div>
                </div>

                <div class="mt-6 space-y-4">
                    <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Other">Other</option>
                    </select>

                    <button id="complete-sale-btn" class="w-full p-4 bg-secondary text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 disabled:opacity-50" disabled>
                        Complete Sale
                    </button>
                    <button id="clear-transaction-btn" class="w-full p-3 bg-danger text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">
                        Clear Transaction
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. Inventory Management View -->
        <!-- FIX APPLIED: Added flex flex-col gap-6 -->
        <div id="inventory-view" class="hidden flex flex-col gap-6">
            <h1 class="text-3xl font-extrabold mb-6 text-primary">Inventory Management</h1>

            <!-- Add/Edit Inventory Item Form -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-primary" id="inventory-form-title">Add New Item</h2>
                <form id="inventory-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="hidden" id="item-id">
                    <input type="text" id="item-name" placeholder="Item Name" required class="p-3 border rounded-lg focus:ring-primary focus:border-primary">
                    <!-- REMOVED: item-cost input field -->
                    <input type="number" id="item-price" placeholder="Selling Price (e.g., 9.99)" step="0.01" required class="p-3 border rounded-lg focus:ring-primary focus:border-primary">
                    <input type="number" id="item-stock" placeholder="Initial/Current Stock" required class="p-3 border rounded-lg focus:ring-primary focus:border-primary">
                    <input type="text" id="item-unit" placeholder="Unit (e.g., ea, kg, box)" required class="p-3 border rounded-lg focus:ring-primary focus:border-primary">

                    <button type="submit" id="inventory-submit-btn" class="p-3 bg-secondary text-white font-semibold rounded-lg hover:bg-emerald-600 transition duration-150 md:col-span-3">
                        Add Item
                    </button>
                    <button type="button" id="inventory-cancel-btn" class="p-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 hidden md:col-span-3">
                        Cancel Edit
                    </button>
                </form>
            </div>

            <!-- Inventory Table -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg overflow-x-auto">
                <h2 class="text-2xl font-semibold mb-4 text-primary">Current Stock</h2>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <!-- REMOVED: Cost Price header -->
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selling Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Inventory items will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. Expense Tracking View (NEW) -->
        <!-- FIX APPLIED: Added flex flex-col gap-6 -->
        <div id="expenses-view" class="hidden flex flex-col gap-6">
            <h1 class="text-3xl font-extrabold mb-6 text-danger">Expense Tracker</h1>

            <!-- Add Expense Form -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg mb-8 border-t-4 border-danger">
                <!-- ADDED ID for form title -->
                <h2 class="text-2xl font-semibold mb-4 text-danger" id="expense-form-title">Log New Expense</h2>
                <form id="expense-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="hidden" id="expense-id">
                    <input type="text" id="expense-description" placeholder="Description (e.g., Propane refill, Permit fee)" required class="p-3 border rounded-lg focus:ring-danger focus:border-danger md:col-span-2">
                    <select id="expense-category" required class="p-3 border rounded-lg focus:ring-danger focus:border-danger">
                        <option value="" disabled selected>Select Category</option>
                        <option value="Ingredients">Ingredients/Supplies</option>
                        <option value="Fuel">Fuel/Gas/Propane</option>
                        <option value="Rent">Rent/Permits/Fees</option>
                        <option value="Utilities">Utilities/Maintenance</option>
                        <option value="Wages">Wages/Payroll</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="number" id="expense-amount" placeholder="Amount" step="0.01" required class="p-3 border rounded-lg focus:ring-danger focus:border-danger">
                    <button type="submit" id="expense-submit-btn" class="p-3 bg-danger text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 md:col-span-4">
                        Log Expense
                    </button>
                    <!-- ADDED CANCEL BUTTON for editing -->
                    <button type="button" id="expense-cancel-btn" class="p-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 hidden md:col-span-4">
                        Cancel Edit
                    </button>
                </form>
            </div>

            <!-- Expenses Table -->
            <div class="bg-card-bg p-6 rounded-xl shadow-lg overflow-x-auto">
                <h2 class="text-2xl font-semibold mb-4 text-danger">Recent Expenses</h2>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <!-- ADDED Actions header -->
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Expense records will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>


        <!-- 4. Sales & P&L Statistics View (UPDATED) -->
        <!-- FIX APPLIED: Added flex flex-col gap-6 -->
        <div id="stats-view" class="hidden flex flex-col gap-6">
            <h1 class="text-3xl font-extrabold mb-6 text-primary">Sales & Profit/Loss Reports</h1>

            <!-- Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 p-6 bg-card-bg rounded-xl shadow-lg">
                <div class="md:col-span-1">
                    <label for="stats-period" class="block text-sm font-medium text-gray-700">Select Period Length</label>
                    <select id="stats-period" class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option> <!-- CHANGED default to Monthly -->
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label for="stats-date-input" class="block text-sm font-medium text-gray-700">Reference Date (Period End)</label>
                    <input type="date" id="stats-date-input" class="w-full p-3 border rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div class="md:col-span-2 flex items-end space-x-2">
                    <button id="stats-nav-prev" class="p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 flex-1">
                        &larr; Previous Period
                    </button>
                    <button id="stats-nav-next" class="p-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 flex-1">
                        Next Period &rarr;
                    </button>
                    <!-- MODIFIED: Export button changed to a dropdown container -->
                    <div class="relative inline-block text-left flex-1" id="export-dropdown-container">
                        <button id="export-dropdown-toggle" class="w-full p-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 flex items-center justify-center space-x-2">
                            <i class="fa-solid fa-file-export"></i>
                            <span>Export <i class="fa-solid fa-chevron-down text-xs ml-2"></i></span>
                        </button>
                        <div id="export-dropdown-menu" class="absolute right-0 mt-2 w-56 origin-top-right rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20">
                            <div class="py-1">
                                <button id="export-pdf-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fa-solid fa-file-pdf mr-2 text-danger"></i> Export PDF
                                </button>
                                <button id="export-csv-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fa-solid fa-file-csv mr-2 text-secondary"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- END MODIFIED: Export button changed to a dropdown container -->
                </div>
            </div>

            <!-- Summary Cards -->
            <div id="summary-cards" class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-card-bg p-4 rounded-xl shadow-md text-center border-b-4 border-primary">
                    <p class="text-sm text-gray-500">Total Sales</p>
                    <p id="stat-sales" class="text-2xl font-bold text-primary">$0.00</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-md text-center border-b-4 border-danger">
                    <p class="text-sm text-gray-500">Total Expenses</p>
                    <p id="stat-expenses" class="text-2xl font-bold text-danger">$0.00</p>
                </div>
                <div class="bg-card-bg p-4 rounded-xl shadow-md text-center border-b-4 border-secondary">
                    <p class="text-sm text-gray-500">Net Profit</p>
                    <p id="stat-profit" class="text-2xl font-bold text-secondary">$0.00</p>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-4">
                    <button class="tab-button active p-3 font-semibold text-gray-500 hover:text-primary transition duration-150" data-tab="charts">Charts View</button>
                    <button class="tab-button p-3 font-semibold text-gray-500 hover:text-primary transition duration-150" data-tab="tables">Tables View (Raw Data)</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="charts-tab" class="tab-content active-tab space-y-8">
                <!-- Profit Trend Chart -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Profit Trend</h2>
                    <!-- MODIFIED: Wrapper div added to constrain chart height -->
                    <div class="relative w-full h-96 max-h-[500px]">
                        <canvas id="profit-chart" class="w-full h-full"></canvas>
                    </div>
                </div>

                <!-- NEW: Expenses Breakdown Pie Chart -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 text-danger">Expenses Breakdown by Category</h2>
                    <!-- Pie charts look better constrained and centered -->
                    <div class="relative w-full h-96 max-w-lg mx-auto"> 
                        <canvas id="expense-pie-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tables-tab" class="tab-content hidden">
                <!-- Sales Log Table -->
                <div id="sales-log-container" class="bg-card-bg p-6 rounded-xl shadow-lg overflow-x-auto mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-primary">Recent Sales Log</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr id="sales-log-header">
                                <!-- ADDED data-sort-key and sortable class for sorting -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="timestamp">Date <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                <!-- ADDED data-sort-key and sortable class for sorting -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="totalAmount">Total Amount <span class="sort-icon"></span></th>
                            </tr>
                        </thead>
                        <tbody id="sales-log-body" class="bg-white divide-y divide-gray-200">
                            <!-- Sales records will be rendered here -->
                        </tbody>
                        <!-- ADDED Footer for Totals -->
                        <tfoot id="sales-log-footer" class="bg-gray-100 font-bold border-t-2 border-primary"></tfoot>
                    </table>
                </div>

                <!-- Expenses Log Table -->
                <div id="expenses-log-container" class="bg-card-bg p-6 rounded-xl shadow-lg overflow-x-auto">
                    <h2 class="text-xl font-semibold mb-4 text-danger">Recent Expenses Log</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr id="expenses-log-header">
                                <!-- ADDED data-sort-key and sortable class for sorting -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="timestamp">Date <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="description">Description <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="category">Category <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer sortable" data-sort-key="amount">Amount <span class="sort-icon"></span></th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-log-body" class="bg-white divide-y divide-gray-200">
                            <!-- Expense records will be rendered here -->
                        </tbody>
                        <!-- ADDED Footer for Totals -->
                        <tfoot id="expenses-log-footer" class="bg-gray-100 font-bold border-t-2 border-danger"></tfoot>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Ensure jspdf is available globally (necessary because it's loaded via CDN)
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // --- Helper Functions and UI Management ---

            const $ = id => document.getElementById(id);

            const showMessage = (text, type = 'success') => {
                const box = $('message-box');
                let bgColor, textColor;

                switch (type) {
                    case 'success':
                        bgColor = 'bg-secondary';
                        textColor = 'text-white';
                        break;
                    case 'error':
                        bgColor = 'bg-danger';
                        textColor = 'text-white';
                        break;
                    case 'info':
                        bgColor = 'bg-primary';
                        textColor = 'text-white';
                        break;
                    default:
                        bgColor = 'bg-gray-500';
                        textColor = 'text-white';
                }

                box.innerHTML = `<div class="p-4 rounded-lg shadow-xl ${bgColor} ${textColor} font-semibold">${text}</div>`;
                box.classList.remove('opacity-0', 'translate-y-[-20px]');
                box.classList.add('opacity-100', 'translate-y-0');

                setTimeout(() => {
                    box.classList.remove('opacity-100', 'translate-y-0');
                    box.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 3000);
            };

            const formatCurrency = (amount) => {
                // CHANGED currency from 'USD' to 'XCD'
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'XCD' 
                }).format(amount);
            };

            // --- IndexedDB Management ---

            const DB_NAME = 'BookKeepPWA_DB';
            const DB_VERSION = 3; 
            const STORE_INVENTORY = 'inventory';
            const STORE_SALES = 'sales';
            const STORE_EXPENSES = 'expenses'; 

            let db;

            const DBManager = {
                async initDB() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(DB_NAME, DB_VERSION);

                        request.onupgradeneeded = (event) => {
                            db = event.target.result;
                            
                            if (!db.objectStoreNames.contains(STORE_INVENTORY)) {
                                db.createObjectStore(STORE_INVENTORY, { keyPath: 'itemId' });
                            }
                            if (!db.objectStoreNames.contains(STORE_SALES)) {
                                db.createObjectStore(STORE_SALES, { keyPath: 'saleId', autoIncrement: true });
                            }
                            if (!db.objectStoreNames.contains(STORE_EXPENSES)) {
                                db.createObjectStore(STORE_EXPENSES, { keyPath: 'expenseId', autoIncrement: true });
                            }
                        };

                        request.onsuccess = (event) => {
                            db = event.target.result;
                            console.log('IndexedDB opened successfully');
                            resolve(db);
                        };

                        request.onerror = (event) => {
                            console.error('IndexedDB error:', event.target.error);
                            showMessage('Database failed to open. Check console.', 'error');
                            reject(event.target.error);
                        };
                    });
                },

                async transaction(storeName, mode, callback) {
                    const transaction = db.transaction(storeName, mode);
                    const store = transaction.objectStore(storeName);

                    return new Promise((resolve, reject) => {
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                        callback(store, resolve, reject);
                    });
                },

                async addItem(storeName, data) {
                    try {
                        await DBManager.transaction(storeName, 'readwrite', (store) => {
                            store.add(data);
                        });
                        return true;
                    } catch (error) {
                        console.error(`Error adding item to ${storeName}:`, error);
                        showMessage(`Error saving item: ${error.name}`, 'error');
                        return false;
                    }
                },

                async updateItem(storeName, data) {
                    try {
                        await DBManager.transaction(storeName, 'readwrite', (store) => {
                            store.put(data);
                        });
                        return true;
                    } catch (error) {
                        console.error(`Error updating item in ${storeName}:`, error);
                        showMessage(`Error updating item: ${error.name}`, 'error');
                        return false;
                    }
                }
                ,

                async getAll(storeName) {
                    let results = [];
                    await DBManager.transaction(storeName, 'readonly', (store, resolve) => {
                        const request = store.openCursor();
                        request.onsuccess = (event) => {
                            const cursor = event.target.result;
                            if (cursor) {
                                results.push(cursor.value);
                                cursor.continue();
                            } else {
                                resolve();
                            }
                        };
                    });
                    return results;
                },

                async getItem(storeName, key) {
                     let result = null;
                     await DBManager.transaction(storeName, 'readonly', (store, resolve) => {
                        const request = store.get(key);
                        request.onsuccess = (event) => {
                            result = event.target.result;
                            resolve();
                        };
                     });
                     return result;
                },

                async deleteItem(storeName, key) {
                    try {
                        await DBManager.transaction(storeName, 'readwrite', (store) => {
                            store.delete(key);
                        });
                        return true;
                    } catch (error) {
                        console.error(`Error deleting item from ${storeName}:`, error);
                        showMessage(`Error deleting item: ${error.name}`, 'error');
                        return false;
                    }
                }
            };

            // --- Application State and Logic ---

            let inventory = [];
            let sales = [];
            let expenses = []; 
            let currentCart = []; 
            let sortingListenersAttached = false; // Flag to prevent attaching multiple listeners

            const state = {
                currentView: 'sales',
                statsTab: 'charts',
                statsRefDate: new Date(), // Defaults to today
                salesSort: { key: 'timestamp', direction: 'desc' }, // Default sort for sales
                expenseSort: { key: 'timestamp', direction: 'desc' } // Default sort for expenses
            };

            // --- Date Utility Functions ---
            
            const formatDateForInput = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            };

            const addDays = (date, days) => {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            };

            const addMonths = (date, months) => {
                const result = new Date(date);
                result.setMonth(result.getMonth() + months);
                return result;
            };

            const addYears = (date, years) => {
                const result = new Date(date);
                result.setFullYear(result.getFullYear() + years);
                return result;
            };

            // --- Inventory View Logic ---

            const loadInventory = async () => {
                const rawInventory = await DBManager.getAll(STORE_INVENTORY);
                inventory = rawInventory.map(item => ({
                    itemId: item.itemId,
                    name: item.name,
                    sellingPrice: item.sellingPrice || item.price || 0, 
                    stockQuantity: item.stockQuantity || 0,
                    unitOfMeasure: item.unitOfMeasure || 'ea'
                }));
                renderInventoryTable();
                renderProductGrid();
            };

            const renderInventoryTable = () => {
                const tbody = $('inventory-table-body');
                tbody.innerHTML = '';

                inventory.forEach(item => {
                    const row = tbody.insertRow();
                    const stockClass = item.stockQuantity < 5 ? 'bg-red-100 font-bold' : '';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatCurrency(item.sellingPrice)}</td>
                        <td class="px-6 py-4 whitespace-nowrap ${stockClass}">${item.stockQuantity} ${item.unitOfMeasure}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button data-item-id="${item.itemId}" class="edit-item-btn text-primary hover:text-indigo-600 font-medium mr-2">Edit</button>
                            <button data-item-id="${item.itemId}" class="delete-item-btn text-danger hover:text-red-600 font-medium">Delete</button>
                        </td>
                    `;
                });

                document.querySelectorAll('.edit-item-btn').forEach(button => {
                    button.onclick = () => editItem(button.dataset.itemId);
                });
                document.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.onclick = () => deleteItem(button.dataset.itemId);
                });
            };

            const handleInventoryForm = async (event) => {
                event.preventDefault();

                const itemId = $('item-id').value || crypto.randomUUID();
                const name = $('item-name').value.trim();
                const sellingPrice = parseFloat($('item-price').value);
                const stockQuantity = parseInt($('item-stock').value);
                const unitOfMeasure = $('item-unit').value.trim();

                const item = {
                    itemId,
                    name,
                    sellingPrice, 
                    stockQuantity,
                    unitOfMeasure
                };

                const isNew = !inventory.some(i => i.itemId === itemId);
                let success;

                if (isNew) {
                    success = await DBManager.addItem(STORE_INVENTORY, item);
                    if (success) showMessage(`${name} added to inventory.`, 'success');
                } else {
                    success = await DBManager.updateItem(STORE_INVENTORY, item);
                    if (success) showMessage(`${name} updated.`, 'info');
                }

                if (success) {
                    $('inventory-form').reset();
                    $('item-id').value = '';
                    $('inventory-form-title').textContent = 'Add New Item';
                    $('inventory-submit-btn').textContent = 'Add Item';
                    $('inventory-cancel-btn').classList.add('hidden');
                    loadInventory(); 
                }
            };

            const editItem = (itemId) => {
                const item = inventory.find(i => i.itemId === itemId);
                if (item) {
                    $('item-id').value = item.itemId;
                    $('item-name').value = item.name;
                    $('item-price').value = item.sellingPrice;
                    $('item-stock').value = item.stockQuantity;
                    $('item-unit').value = item.unitOfMeasure;

                    $('inventory-form-title').textContent = `Edit Item: ${item.name}`;
                    $('inventory-submit-btn').textContent = 'Update Item';
                    $('inventory-cancel-btn').classList.remove('hidden');

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const deleteItem = async (itemId) => {
                const item = inventory.find(i => i.itemId === itemId);
                if (confirm(`Are you sure you want to delete ${item.name}? This action cannot be undone.`)) {
                    const success = await DBManager.deleteItem(STORE_INVENTORY, itemId);
                    if (success) {
                        showMessage(`${item.name} deleted.`, 'error');
                        loadInventory();
                    }
                }
            };

            $('inventory-cancel-btn').onclick = () => {
                $('inventory-form').reset();
                $('item-id').value = '';
                $('inventory-form-title').textContent = 'Add New Item';
                $('inventory-submit-btn').textContent = 'Add Item';
                $('inventory-cancel-btn').classList.add('hidden');
            };

            // --- Sales/Register View Logic (Unchanged) ---

            const renderProductGrid = (searchTerm = '') => {
                const grid = $('product-list');
                grid.innerHTML = '';
                const term = searchTerm.toLowerCase();

                const filteredInventory = inventory.filter(item =>
                    item.name.toLowerCase().includes(term)
                );

                if (filteredInventory.length === 0) {
                     grid.innerHTML = '<p class="col-span-4 text-center text-gray-500">No products found or in stock.</p>';
                }

                filteredInventory.forEach(item => {
                    const card = document.createElement('div');
                    const lowStock = item.stockQuantity < 5;
                    const disabled = item.stockQuantity <= 0;

                    card.className = `product-card p-4 rounded-xl shadow-md cursor-pointer transition duration-150 ${disabled ? 'bg-gray-200 opacity-60' : 'bg-secondary/10 hover:bg-secondary/20 hover:shadow-lg'}`;
                    card.innerHTML = `
                        <p class="font-semibold text-gray-900 truncate">${item.name}</p>
                        <p class="text-xl font-extrabold text-primary mt-1">${formatCurrency(item.sellingPrice)}</p>
                        <p class="text-xs ${lowStock ? 'text-danger font-bold' : 'text-gray-500'}">Stock: ${item.stockQuantity} ${item.unitOfMeasure}</p>
                    `;
                    card.onclick = () => addItemToCart(item);
                    card.dataset.itemId = item.itemId;
                    grid.appendChild(card);
                });
            };

            const addItemToCart = (item) => {
                if (item.stockQuantity <= 0) {
                    showMessage(`${item.name} is out of stock!`, 'error');
                    return;
                }

                const cartItem = currentCart.find(c => c.itemId === item.itemId);

                if (cartItem) {
                    if (cartItem.quantity < item.stockQuantity) {
                        cartItem.quantity++;
                    } else {
                        showMessage(`Max stock reached for ${item.name}.`, 'error');
                    }
                } else {
                    currentCart.push({
                        itemId: item.itemId,
                        name: item.name,
                        price: item.sellingPrice,
                        quantity: 1
                    });
                }
                renderCart();
            };

            const renderCart = () => {
                const cartContainer = $('cart-items');
                cartContainer.innerHTML = '';

                let subtotal = 0;

                currentCart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 border-b last:border-b-0';
                    div.innerHTML = `
                        <div class="flex-1">
                            <p class="font-medium truncate">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${item.itemId}" class="qty-btn text-primary hover:text-indigo-600 font-bold">-</button>
                            <span class="font-bold w-12 text-center">${formatCurrency(itemTotal)}</span>
                            <button data-id="${item.itemId}" class="qty-btn text-primary hover:text-indigo-600 font-bold">+</button>
                        </div>
                    `;
                    cartContainer.appendChild(div);
                });

                const total = subtotal; 
                $('cart-subtotal').textContent = formatCurrency(subtotal);
                $('cart-total').textContent = formatCurrency(total);

                $('complete-sale-btn').disabled = currentCart.length === 0;

                document.querySelectorAll('.qty-btn').forEach(btn => {
                    btn.onclick = (e) => updateCartQuantity(e.target.dataset.id, e.target.textContent.trim());
                });
            };

            const updateCartQuantity = (itemId, action) => {
                const item = currentCart.find(c => c.itemId === itemId);
                const inventoryItem = inventory.find(i => i.itemId === itemId);

                if (!item || !inventoryItem) return;

                if (action === '+') {
                    if (item.quantity < inventoryItem.stockQuantity) {
                        item.quantity++;
                    } else {
                        showMessage(`Max stock reached for ${item.name}.`, 'error');
                    }
                } else if (action === '-') {
                    item.quantity--;
                    if (item.quantity <= 0) {
                        currentCart = currentCart.filter(c => c.itemId !== itemId);
                    }
                }
                renderCart();
            };

            const completeSale = async () => {
                if (currentCart.length === 0) return;

                const saleTime = Date.now();
                let totalAmount = 0;
                let itemsSold = [];

                for (const cartItem of currentCart) {
                    const itemTotal = cartItem.price * cartItem.quantity;
                    totalAmount += itemTotal;

                    itemsSold.push({
                        itemId: cartItem.itemId,
                        quantity: cartItem.quantity,
                        priceAtSale: cartItem.price,
                    });

                    const stockItem = inventory.find(i => i.itemId === cartItem.itemId);
                    if (stockItem) {
                        stockItem.stockQuantity -= cartItem.quantity;
                        await DBManager.updateItem(STORE_INVENTORY, stockItem);
                    }
                }

                const saleRecord = {
                    timestamp: saleTime,
                    totalAmount: totalAmount,
                    itemsSold: itemsSold,
                    paymentMethod: $('payment-method').value
                };

                const success = await DBManager.addItem(STORE_SALES, saleRecord);

                if (success) {
                    showMessage(`Sale completed for ${formatCurrency(totalAmount)}.`, 'success');
                    currentCart = [];
                    renderCart();
                    loadInventory(); 
                } else {
                    showMessage('Error completing sale.', 'error');
                }
            };

            $('product-search').oninput = (e) => renderProductGrid(e.target.value);
            $('clear-transaction-btn').onclick = () => {
                currentCart = [];
                renderCart();
                showMessage('Transaction cleared.', 'info');
            };
            $('complete-sale-btn').onclick = completeSale;

            // --- Expense View Logic ---

            const loadExpenses = async () => {
                expenses = await DBManager.getAll(STORE_EXPENSES);
                renderExpensesTable();
            };
            
            const resetExpenseForm = () => {
                $('expense-form').reset();
                $('expense-id').value = '';
                $('expense-form-title').textContent = 'Log New Expense';
                $('expense-submit-btn').textContent = 'Log Expense';
                $('expense-cancel-btn').classList.add('hidden');
            };
            
            $('expense-cancel-btn').onclick = resetExpenseForm;

            const editExpense = (expenseId) => {
                const expense = expenses.find(e => e.expenseId == expenseId);
                if (expense) {
                    $('expense-id').value = expense.expenseId;
                    $('expense-description').value = expense.description;
                    $('expense-category').value = expense.category;
                    $('expense-amount').value = expense.amount;

                    $('expense-form-title').textContent = `Edit Expense: ${expense.description}`;
                    $('expense-submit-btn').textContent = 'Update Expense';
                    $('expense-cancel-btn').classList.remove('hidden');

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            const deleteExpense = async (expenseId) => {
                // Ensure expenseId is an integer for IndexedDB lookup
                const idToDelete = parseInt(expenseId);
                const expense = expenses.find(e => e.expenseId === idToDelete);

                if (expense && confirm(`Are you sure you want to delete the expense: ${expense.description} (${formatCurrency(expense.amount)})?`)) {
                    const success = await DBManager.deleteItem(STORE_EXPENSES, idToDelete);
                    if (success) {
                        showMessage(`${expense.description} deleted.`, 'error');
                        loadExpenses();
                    }
                }
            };


            const handleExpenseForm = async (event) => {
                event.preventDefault();

                const expenseId = $('expense-id').value ? parseInt($('expense-id').value) : null;
                const expenseAmount = parseFloat($('expense-amount').value);
                const expenseDescription = $('expense-description').value.trim();
                const expenseCategory = $('expense-category').value;

                if (!expenseCategory) {
                    showMessage('Please select an expense category.', 'error');
                    return;
                }

                // If editing, preserve original timestamp. Otherwise, set new timestamp.
                const originalTimestamp = expenseId ? expenses.find(e => e.expenseId === expenseId)?.timestamp : Date.now();

                const expenseRecord = {
                    ...(expenseId && { expenseId }), 
                    timestamp: originalTimestamp || Date.now(),
                    amount: expenseAmount,
                    description: expenseDescription,
                    category: expenseCategory
                };

                let success;
                if (expenseId) {
                    success = await DBManager.updateItem(STORE_EXPENSES, expenseRecord);
                    if (success) showMessage(`Expense updated: ${expenseDescription}.`, 'info');
                } else {
                    success = await DBManager.addItem(STORE_EXPENSES, expenseRecord);
                    if (success) showMessage(`Expense logged: ${formatCurrency(expenseAmount)} for ${expenseDescription}.`, 'danger');
                }

                if (success) {
                    resetExpenseForm();
                    loadExpenses();
                } else {
                    showMessage('Error processing expense.', 'error');
                }
            };

            const renderExpensesTable = () => {
                const tbody = $('expenses-table-body');
                tbody.innerHTML = '';

                // Sort by timestamp descending
                const sortedExpenses = [...expenses].sort((a, b) => b.timestamp - a.timestamp);

                sortedExpenses.forEach(expense => {
                    const date = new Date(expense.timestamp).toLocaleDateString();

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-4">${expense.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${expense.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-danger font-bold">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button data-expense-id="${expense.expenseId}" class="edit-expense-btn text-primary hover:text-indigo-600 font-medium mr-2">Edit</button>
                            <button data-expense-id="${expense.expenseId}" class="delete-expense-btn text-danger hover:text-red-600 font-medium">Delete</button>
                        </td>
                    `;
                });
                
                // Add listeners to new buttons
                document.querySelectorAll('.edit-expense-btn').forEach(button => {
                    button.onclick = () => editExpense(button.dataset.expenseId);
                });
                document.querySelectorAll('.delete-expense-btn').forEach(button => {
                    button.onclick = () => deleteExpense(button.dataset.expenseId);
                });
            };

            $('expense-form').addEventListener('submit', handleExpenseForm);

            // --- Statistics View Logic ---

            let profitChartInstance = null;
            let expenseChartInstance = null; // NEW: Expense chart instance
            let filteredSalesData = []; // Store filtered data for export
            let filteredExpensesData = []; // Store filtered data for export

            const toggleExportDropdown = () => {
                $('export-dropdown-menu').classList.toggle('hidden');
            };

            const initializeStatsControls = () => {
                // Set default reference date to today
                $('stats-date-input').value = formatDateForInput(state.statsRefDate);

                $('stats-period').onchange = updateStats;
                $('stats-date-input').onchange = (e) => {
                    state.statsRefDate = new Date(e.target.value);
                    updateStats();
                };

                $('stats-nav-prev').onclick = () => navigatePeriod(-1);
                $('stats-nav-next').onclick = () => navigatePeriod(1);
                
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.onclick = (e) => switchStatsTab(e.target.dataset.tab);
                });
                
                // Export Dropdown Listeners
                $('export-dropdown-toggle').onclick = toggleExportDropdown;
                $('export-pdf-btn').onclick = () => {
                    toggleExportDropdown();
                    exportReportToPDF();
                };
                $('export-csv-btn').onclick = () => {
                    toggleExportDropdown();
                    exportReportToCSV(); // NEW CSV Export Handler
                };


                // Attach sorting listeners only once
                if (!sortingListenersAttached) {
                    setupTableSorting('sales-log-header', 'salesSort', updateStats);
                    setupTableSorting('expenses-log-header', 'expenseSort', updateStats);
                    sortingListenersAttached = true;
                }
            };

            const navigatePeriod = (direction) => {
                const period = $('stats-period').value;
                const currentDate = state.statsRefDate;
                
                let newDate = new Date(currentDate);

                if (period === 'daily') {
                    newDate = addDays(newDate, direction);
                } else if (period === 'weekly') {
                    newDate = addDays(newDate, direction * 7);
                } else if (period === 'monthly') {
                    newDate = addMonths(newDate, direction);
                } else if (period === 'all') {
                    // Cannot navigate 'All Time', but we can navigate by year
                    newDate = addYears(newDate, direction);
                }
                
                state.statsRefDate = newDate;
                $('stats-date-input').value = formatDateForInput(newDate);
                updateStats();
            };

            const switchStatsTab = (newTab) => {
                state.statsTab = newTab;
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

                $(`${newTab}-tab`).classList.remove('hidden');
                document.querySelector(`.tab-button[data-tab="${newTab}"]`).classList.add('active');
            };

            const loadSalesData = async () => {
                // 1. Ensure inventory is loaded and processed first, as it is needed to render sales logs accurately.
                await loadInventory(); 
                
                // 2. Load Sales and Expenses
                sales = await DBManager.getAll(STORE_SALES);
                expenses = await DBManager.getAll(STORE_EXPENSES);
                
                // 3. Update all stats
                updateStats();
            };

            const getFilteredData = () => {
                const period = $('stats-period').value;
                const referenceTimestamp = state.statsRefDate.getTime();
                
                const filteredSales = filterByPeriod(sales, period, referenceTimestamp);
                const filteredExpenses = filterByPeriod(expenses, period, referenceTimestamp);

                return { sales: filteredSales, expenses: filteredExpenses };
            };


            const updateStats = () => {
                const { sales: currentSales, expenses: currentExpenses } = getFilteredData();

                // Store for export functions
                filteredSalesData = currentSales;
                filteredExpensesData = currentExpenses;

                let totalSales = 0;
                let totalExpenses = 0;

                currentSales.forEach(sale => {
                    totalSales += sale.totalAmount;
                });
                
                currentExpenses.forEach(expense => {
                    totalExpenses += expense.amount;
                });

                const netProfit = totalSales - totalExpenses;

                $('stat-sales').textContent = formatCurrency(totalSales);
                $('stat-expenses').textContent = formatCurrency(totalExpenses);
                $('stat-profit').textContent = formatCurrency(netProfit);

                renderSalesLog(currentSales);
                renderExpensesLog(currentExpenses); 
                renderProfitChart(currentSales, currentExpenses, $('stats-period').value);
                renderExpensePieChart(currentExpenses, $('stats-period').value);
            };

            const filterByPeriod = (data, period, referenceTimestamp) => {
                if (period === 'all') {
                    return data;
                }
                
                const refDate = new Date(referenceTimestamp);
                
                let startOfPeriod = new Date(refDate);
                let endOfPeriod = new Date(refDate);

                if (period === 'daily') {
                    startOfPeriod.setHours(0, 0, 0, 0);
                    endOfPeriod.setHours(23, 59, 59, 999);
                } else if (period === 'weekly') {
                    // Set start to Sunday (0) of the reference week
                    const dayOfWeek = refDate.getDay(); 
                    startOfPeriod = addDays(startOfPeriod, -dayOfWeek); 
                    startOfPeriod.setHours(0, 0, 0, 0);
                    
                    // Set end to Saturday (6) of the reference week
                    endOfPeriod = addDays(startOfPeriod, 6);
                    endOfPeriod.setHours(23, 59, 59, 999);

                } else if (period === 'monthly') {
                    // Set start to the 1st day of the reference month
                    startOfPeriod.setDate(1);
                    startOfPeriod.setHours(0, 0, 0, 0);
                    
                    // Set end to the last day of the reference month
                    endOfPeriod = new Date(startOfPeriod);
                    endOfPeriod.setMonth(endOfPeriod.getMonth() + 1);
                    endOfPeriod.setDate(0); // Rolls back to the last day of the current month
                    endOfPeriod.setHours(23, 59, 59, 999);
                }

                // Respect the user's reference date as the maximum boundary for the report
                const requestedEndBoundary = new Date(referenceTimestamp);
                requestedEndBoundary.setHours(23, 59, 59, 999);

                const startTime = startOfPeriod.getTime();
                // Use the earlier of the calculated end of the period or the user's requested end date
                const endTime = Math.min(endOfPeriod.getTime(), requestedEndBoundary.getTime());
                
                return data.filter(item => item.timestamp >= startTime && item.timestamp <= endTime);
            };
            
            // --- New Sorting Logic ---
            
            const sortData = (data, key, direction) => {
                if (!key) return data;

                return data.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];

                    // Type conversion for accurate sorting
                    if (key === 'timestamp' || key === 'totalAmount' || key === 'amount') {
                        valA = Number(valA);
                        valB = Number(valB);
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }

                    let comparison = 0;
                    if (valA > valB) {
                        comparison = 1;
                    } else if (valA < valB) {
                        comparison = -1;
                    }

                    return direction === 'asc' ? comparison : comparison * -1;
                });
            };
            
            const setupTableSorting = (headerId, stateKey, updateFunction) => {
                 document.querySelectorAll(`#${headerId} .sortable`).forEach(header => {
                    header.onclick = () => {
                        const key = header.dataset.sortKey;
                        let sortState = state[stateKey];

                        // Determine new direction
                        let newDirection = 'desc';
                        if (sortState.key === key) {
                            newDirection = sortState.direction === 'desc' ? 'asc' : 'desc';
                        }

                        // Update state
                        state[stateKey] = { key, direction: newDirection };
                        updateFunction(); // Calls updateStats to re-render sorted data
                    };
                });
            };

            const renderSalesLog = (filteredSales) => {
                const tbody = $('sales-log-body');
                tbody.innerHTML = '';
                
                // Apply sorting
                const sortedSales = sortData([...filteredSales], state.salesSort.key, state.salesSort.direction);

                // Create a quick lookup map for inventory items to ensure fast and correct lookup
                const inventoryMap = inventory.reduce((map, item) => {
                    map[item.itemId] = item;
                    return map;
                }, {});

                let totalSalesAmount = 0;

                sortedSales.forEach(sale => {
                    const date = new Date(sale.timestamp).toLocaleString();
                    totalSalesAmount += sale.totalAmount;
                    
                    const itemsList = sale.itemsSold.map(item => {
                        const inventoriedItem = inventoryMap[item.itemId];
                        return `${item.quantity}x (${inventoriedItem?.name || 'Unknown Item'})`; 
                    }).join(', ');

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-4">${itemsList}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-secondary font-bold">${formatCurrency(sale.totalAmount)}</td>
                    `;
                });
                
                // --- Totals Row (Footer) ---
                const tfoot = $('sales-log-footer');
                tfoot.innerHTML = `
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap" colspan="2">TOTAL SALES AMOUNT</td>
                        <td class="px-6 py-3 whitespace-nowrap text-secondary font-extrabold">${formatCurrency(totalSalesAmount)}</td>
                    </tr>
                `;

                // --- Set Sort Indicators ---
                document.querySelectorAll('#sales-log-header .sortable').forEach(h => {
                    h.classList.remove('sort-active');
                    h.querySelector('.sort-icon').textContent = ''; // Clear icon

                    if (h.dataset.sortKey === state.salesSort.key) {
                        h.classList.add('sort-active');
                        // Unicode:  (up/asc),  (down/desc)
                        h.querySelector('.sort-icon').textContent = state.salesSort.direction === 'asc' ? ' \u25B2' : ' \u25BC';
                    }
                });
            };
            
            const renderExpensesLog = (filteredExpenses) => {
                const tbody = $('expenses-log-body');
                tbody.innerHTML = '';
                
                // Apply sorting
                const sortedExpenses = sortData([...filteredExpenses], state.expenseSort.key, state.expenseSort.direction);

                let totalExpenseAmount = 0;

                sortedExpenses.forEach(expense => {
                    const date = new Date(expense.timestamp).toLocaleString();
                    totalExpenseAmount += expense.amount;
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-4">${expense.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${expense.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-danger font-bold">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button data-expense-id="${expense.expenseId}" class="edit-expense-btn text-primary hover:text-indigo-600 font-medium mr-2">Edit</button>
                            <button data-expense-id="${expense.expenseId}" class="delete-expense-btn text-danger hover:text-red-600 font-medium">Delete</button>
                        </td>
                    `;
                });
                
                // Reattach Edit/Delete listeners (necessary since tbody was cleared)
                document.querySelectorAll('#expenses-log-body .edit-expense-btn').forEach(button => {
                    button.onclick = () => editExpense(button.dataset.expenseId);
                });
                document.querySelectorAll('#expenses-log-body .delete-expense-btn').forEach(button => {
                    button.onclick = () => deleteExpense(button.dataset.expenseId);
                });

                // --- Totals Row (Footer) ---
                const tfoot = $('expenses-log-footer');
                tfoot.innerHTML = `
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap" colspan="3">TOTAL EXPENSES AMOUNT</td>
                        <td class="px-6 py-3 whitespace-nowrap text-right text-danger font-extrabold">${formatCurrency(totalExpenseAmount)}</td>
                        <td class="px-6 py-3 whitespace-nowrap"></td>
                    </tr>
                `;

                // --- Set Sort Indicators ---
                document.querySelectorAll('#expenses-log-header .sortable').forEach(h => {
                    h.classList.remove('sort-active');
                    h.querySelector('.sort-icon').textContent = ''; // Clear icon

                    if (h.dataset.sortKey === state.expenseSort.key) {
                        h.classList.add('sort-active');
                        h.querySelector('.sort-icon').textContent = state.expenseSort.direction === 'asc' ? ' \u25B2' : ' \u25BC';
                    }
                });
            };


            const aggregateDataForChart = (filteredSales, filteredExpenses, period) => {
                const aggregation = {}; 
                
                const getPeriodKey = (date, period) => {
                    const d = new Date(date);
                    if (period === 'daily') return d.toISOString().split('T')[0];
                    if (period === 'weekly') {
                        const dayNum = d.getUTCDay() || 7;
                        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                        return `${d.getFullYear()}-W${weekNo}`;
                    }
                    return `${d.getFullYear()}-${d.getMonth() + 1}`; 
                };
                
                // Aggregate Sales
                filteredSales.forEach(sale => {
                    const date = new Date(sale.timestamp);
                    const key = getPeriodKey(date, period);

                    if (!aggregation[key]) {
                        aggregation[key] = { sales: 0, expenses: 0 };
                    }
                    aggregation[key].sales += sale.totalAmount;
                });
                
                // Aggregate Expenses
                filteredExpenses.forEach(expense => {
                    const date = new Date(expense.timestamp);
                    const key = getPeriodKey(date, period);

                    if (!aggregation[key]) {
                        aggregation[key] = { sales: 0, expenses: 0 };
                    }
                    aggregation[key].expenses += expense.amount;
                });

                const sortedKeys = Object.keys(aggregation).sort();
                const labels = sortedKeys;
                const salesData = sortedKeys.map(key => aggregation[key].sales);
                const netProfitData = sortedKeys.map(key => aggregation[key].sales - aggregation[key].expenses);

                return { labels, salesData, netProfitData };
            };

            const renderProfitChart = (filteredSales, filteredExpenses, period) => {
                const chartData = aggregateDataForChart(filteredSales, filteredExpenses, period);
                const ctx = $('profit-chart').getContext('2d');

                if (profitChartInstance) {
                    profitChartInstance.destroy();
                }

                profitChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Total Sales',
                                data: chartData.salesData,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Net Profit (Sales - Expenses)',
                                data: chartData.netProfitData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Essential for height control
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: `Sales and Net Profit Trend (${period.toUpperCase()})`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false, 
                                title: {
                                    display: true,
                                    text: 'Amount (XCD)' // Updated chart axis title
                                }
                            }
                        }
                    }
                });
            };

            // NEW: Expense Pie Chart Logic
            
            const aggregateExpensesByCategory = (expenses) => {
                const aggregation = {};
                let total = 0;

                expenses.forEach(expense => {
                    const category = expense.category || 'Uncategorized';
                    const amount = expense.amount;
                    
                    if (!aggregation[category]) {
                        aggregation[category] = 0;
                    }
                    aggregation[category] += amount;
                    total += amount;
                });

                const labels = Object.keys(aggregation);
                const data = labels.map(label => aggregation[label]);
                
                return { labels, data, total };
            };

            const renderExpensePieChart = (filteredExpenses, period) => {
                const chartData = aggregateExpensesByCategory(filteredExpenses);
                const ctx = $('expense-pie-chart').getContext('2d');

                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                }
                
                // Only render if there are expenses to display
                if (chartData.total === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    return;
                }

                // Standard colors for consistency and visibility
                const backgroundColors = [
                    '#ef4444', // Danger (Red)
                    '#4f46e5', // Primary (Indigo)
                    '#10b981', // Secondary (Emerald)
                    '#f97316', // Orange
                    '#06b6d4', // Cyan
                    '#8b5cf6', // Violet
                    '#f59e0b', // Amber
                    '#6b7280', // Gray
                ];

                expenseChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Using doughnut is a nice visual touch
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: backgroundColors.slice(0, chartData.labels.length),
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right', // Place legend on the side
                                labels: {
                                    // Add percentage to legend labels
                                    generateLabels: (chart) => {
                                        const data = chart.data.datasets[0].data;
                                        return chart.data.labels.map((label, i) => {
                                            const total = data.reduce((sum, value) => sum + value, 0);
                                            const percentage = total > 0 ? ((data[i] / total) * 100).toFixed(1) : '0.0';
                                            return {
                                                text: `${label}: ${percentage}% (${formatCurrency(data[i])})`,
                                                fillStyle: chart.data.datasets[0].backgroundColor[i],
                                                strokeStyle: chart.data.datasets[0].backgroundColor[i],
                                                lineWidth: 0,
                                                hidden: chart.getDatasetMeta(0).data[i].hidden,
                                                index: i,
                                            };
                                        });
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `Total Expenses: ${formatCurrency(chartData.total)}`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            };

            // NEW: Export to CSV Logic
            const exportReportToCSV = () => {
                const period = $('stats-period').value;
                const refDate = new Date(state.statsRefDate).toLocaleDateString();
                const filename = `Report_${period}_${refDate.replace(/\//g, '-')}.csv`;

                const salesHeader = ['Type', 'Timestamp', 'Date_Time', 'Total_Amount', 'Items_Sold'];
                const expensesHeader = ['Type', 'Timestamp', 'Date_Time', 'Amount', 'Description', 'Category'];

                let csvContent = "data:text/csv;charset=utf-8,";
                
                // --- Sales Data ---
                csvContent += '*** SALES LOG ***\n';
                csvContent += salesHeader.join(',') + '\n';

                const inventoryMap = inventory.reduce((map, item) => {
                    map[item.itemId] = item;
                    return map;
                }, {});

                const sortedSales = sortData([...filteredSalesData], 'timestamp', 'desc');

                sortedSales.forEach(sale => {
                    const dateTime = new Date(sale.timestamp).toLocaleString();
                    const items = sale.itemsSold.map(item => {
                        const name = inventoryMap[item.itemId]?.name || 'Unknown';
                        return `${item.quantity}x ${name} @${item.priceAtSale}`;
                    }).join(' | ');

                    const row = [
                        'SALE',
                        sale.timestamp,
                        `"${dateTime}"`,
                        sale.totalAmount.toFixed(2),
                        `"${items}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // --- Sales Totals ---
                const totalSalesAmount = filteredSalesData.reduce((sum, sale) => sum + sale.totalAmount, 0);
                csvContent += `\nTOTAL SALES AMOUNT,,-,${totalSalesAmount.toFixed(2)},-\n`;


                // --- Expenses Data ---
                csvContent += '\n*** EXPENSES LOG ***\n';
                csvContent += expensesHeader.join(',') + '\n';

                const sortedExpenses = sortData([...filteredExpensesData], 'timestamp', 'desc');

                sortedExpenses.forEach(expense => {
                    const dateTime = new Date(expense.timestamp).toLocaleString();
                    const row = [
                        'EXPENSE',
                        expense.timestamp,
                        `"${dateTime}"`,
                        expense.amount.toFixed(2),
                        `"${expense.description}"`,
                        `"${expense.category}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                // --- Expenses Totals ---
                const totalExpenseAmount = filteredExpensesData.reduce((sum, expense) => sum + expense.amount, 0);
                csvContent += `\nTOTAL EXPENSES AMOUNT,,-,${totalExpenseAmount.toFixed(2)},-,-\n`;

                // --- Trigger Download ---
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('CSV generated and downloading.', 'secondary');
            };
            
            // --- PDF Export Logic ---
            const exportReportToPDF = async () => {
                const btn = $('export-dropdown-toggle');
                btn.disabled = true;
                btn.querySelector('span').textContent = 'Generating...';
                showMessage('Generating PDF report...', 'info');

                try {
                    const period = $('stats-period').value;
                    const refDate = new Date(state.statsRefDate).toLocaleDateString();
                    const title = `P&L Report: ${period.toUpperCase()} ending ${refDate}`;
                    
                    const doc = new jsPDF('p', 'mm', 'a4');
                    let yPos = 10;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 10;
                    const maxLineWidth = pageWidth - 2 * margin;

                    // --- 1. Report Title and Metadata ---
                    doc.setFontSize(16);
                    doc.text("Food Truck BookKeep Pro", margin, yPos);
                    yPos += 7;
                    doc.setFontSize(12);
                    doc.text(title, margin, yPos);
                    yPos += 15;

                    // --- 2. Summary Cards (Text Breakdown) ---
                    doc.setFontSize(12);
                    doc.text("Financial Summary", margin, yPos);
                    yPos += 5;
                    
                    const sales = $('stat-sales').textContent;
                    const expenses = $('stat-expenses').textContent;
                    const profit = $('stat-profit').textContent;
                    
                    // Simplified currency extraction: rely on the UI content being correctly formatted by formatCurrency
                    const totalSalesAmount = sales || formatCurrency(0); 
                    const totalExpenseAmount = expenses || formatCurrency(0);


                    doc.setFontSize(10);
                    doc.text(`Total Sales: ${sales}`, margin, yPos);
                    yPos += 5;
                    doc.text(`Total Expenses: ${expenses}`, margin, yPos);
                    yPos += 5;
                    doc.text(`Net Profit: ${profit}`, margin, yPos);
                    yPos += 10;

                    // --- 3. Chart Capture (Profit Trend) ---
                    doc.setFontSize(12);
                    doc.text("Profit Trend Chart", margin, yPos);
                    yPos += 5;

                    const profitCanvas = $('profit-chart');
                    const profitCanvasImg = profitCanvas.toDataURL('image/png', 1.0);
                    
                    let imgWidth = 180; 
                    let imgHeight = (profitCanvas.height * imgWidth) / profitCanvas.width;
                    
                    doc.addImage(profitCanvasImg, 'PNG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 10;
                    
                    // --- 4. Chart Capture (Expenses Breakdown) ---
                    doc.setFontSize(12);
                    doc.text("Expenses Breakdown by Category", margin, yPos);
                    yPos += 5;

                    const expenseCanvas = $('expense-pie-chart');
                    const expenseCanvasImg = expenseCanvas.toDataURL('image/png', 1.0);
                    
                    // Use a smaller image size for the doughnut chart
                    imgWidth = 100; // Smaller width
                    imgHeight = (expenseCanvas.height * imgWidth) / expenseCanvas.width;
                    
                    doc.addImage(expenseCanvasImg, 'PNG', margin, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 10;


                    // --- 5. Raw Tables (Sales Log) ---
                    doc.setFontSize(12);
                    doc.text("Sales Log (Raw Data)", margin, yPos);
                    yPos += 5;
                    
                    const salesTableData = [];
                    const salesHeader = ['Date', 'Items Sold', 'Total Amount'];
                    salesTableData.push(salesHeader);
                    
                    document.querySelectorAll('#sales-log-body tr').forEach(row => {
                        const rowData = Array.from(row.cells).map(cell => cell.textContent.trim());
                        salesTableData.push(rowData.slice(0, 3)); 
                    });
                    
                    // Add Sales Totals Row
                    salesTableData.push(['TOTAL SALES AMOUNT', '', totalSalesAmount]);

                    doc.autoTable({
                        startY: yPos,
                        head: [salesTableData[0]],
                        body: salesTableData.slice(1, -1), // All rows except the last one (total)
                        foot: [salesTableData.slice(-1)[0]], // Only the last row (total)
                        styles: { fontSize: 8, cellPadding: 2, lineWidth: 0.1 },
                        footStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold' },
                        columnStyles: {
                            0: { cellWidth: 30 }, 
                            1: { cellWidth: 120 }, 
                            2: { cellWidth: 30 }
                        },
                        margin: { left: margin, right: margin }
                    });
                    yPos = doc.autoTable.previous.finalY + 10;
                    
                    // --- 6. Raw Tables (Expenses Log) ---
                    doc.setFontSize(12);
                    doc.text("Expenses Log (Raw Data)", margin, yPos);
                    yPos += 5;

                    const expenseTableData = [];
                    const expenseHeader = ['Date', 'Description', 'Category', 'Amount'];
                    expenseTableData.push(expenseHeader);

                    document.querySelectorAll('#expenses-log-body tr').forEach(row => {
                        const rowData = Array.from(row.cells).map(cell => cell.textContent.trim());
                        // Only take the first 4 columns (Date, Description, Category, Amount)
                        expenseTableData.push(rowData.slice(0, 4)); 
                    });
                    
                    // Add Expense Totals Row
                    expenseTableData.push(['TOTAL EXPENSES AMOUNT', '', '', totalExpenseAmount]);

                    doc.autoTable({
                        startY: yPos,
                        head: [expenseTableData[0]],
                        body: expenseTableData.slice(1, -1), // All rows except the last one (total)
                        foot: [expenseTableData.slice(-1)[0]], // Only the last row (total)
                        styles: { fontSize: 8, cellPadding: 2, lineWidth: 0.1 },
                        footStyles: { fillColor: [230, 230, 230], textColor: [0, 0, 0], fontStyle: 'bold' },
                        columnStyles: {
                            0: { cellWidth: 30 }, 
                            1: { cellWidth: 60 }, 
                            2: { cellWidth: 60 },
                            3: { cellWidth: 30 }
                        },
                        margin: { left: margin, right: margin }
                    });
                    
                    // --- 7. Save File ---
                    const filename = `P&L_Report_${period}_${refDate.replace(/\//g, '-')}.pdf`;
                    doc.save(filename);
                    
                    showMessage('PDF generated successfully!', 'success');

                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    showMessage('Error generating PDF. See console for details.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.querySelector('span').innerHTML = 'Export <i class="fa-solid fa-chevron-down text-xs ml-2"></i>';
                }
            };
            
            // --- View Switching ---

            const switchView = async (newView) => { // CHANGED to async
                document.querySelectorAll('.active-view').forEach(view => {
                    view.classList.add('hidden');
                    view.classList.remove('active-view');
                });
                const targetView = $(`${newView}-view`);
                
                // FIX: Check if targetView exists before trying to access its classList
                if (!targetView) {
                    console.error(`Attempted to switch to view: ${newView}, but element ${newView}-view was not found.`);
                    showMessage(`Error switching view: ${newView} not found.`, 'error');
                    return; 
                }

                // FIX: Ensure the 'hidden' class is removed before attempting to use the view.
                targetView.classList.remove('hidden'); 
                targetView.classList.add('active-view');
                state.currentView = newView;

                // Load data for the specific view on switch
                if (newView === 'inventory') {
                    await loadInventory(); // ADDED await
                } else if (newView === 'expenses') {
                    await loadExpenses(); // ADDED await
                } else if (newView === 'stats') {
                    initializeStatsControls(); // Initialize controls on first load
                    await loadSalesData(); // ADDED await
                    switchStatsTab(state.statsTab); // Ensure correct tab is active
                }
            };

            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // FIX: Use e.currentTarget to get the data-view attribute from the BUTTON element, not the clicked icon or span child.
                    const viewName = e.currentTarget.dataset.view; 
                    
                    // Call switchView asynchronously to ensure data loading completes before the view is fully rendered/interacted with
                    switchView(viewName).catch(err => {
                        console.error("Error switching view:", err);
                        showMessage("Failed to load data for the view. See console.", 'error');
                    });
                });
            });

            // --- Initialization ---

            DBManager.initDB().then(() => {
                // Initialize the main views after DB is ready
                switchView(state.currentView);
                loadInventory();
            });

            $('inventory-form').addEventListener('submit', handleInventoryForm);

        });
    </script>
</body>
</html>
